<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Icertis ‚Äì AI Risk Orchestrator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #020617;
      --bg-alt: #020617;
      --card: #020617;
      --border-subtle: rgba(148,163,184,0.4);
      --accent: #2563eb;
      --accent-soft: rgba(37,99,235,0.08);
      --accent-strong: #1d4ed8;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;
      --danger: #dc2626;
      --success: #16a34a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background:
        radial-gradient(circle at top, rgba(59,130,246,0.35), transparent 55%),
        radial-gradient(circle at bottom, rgba(22,163,74,0.22), transparent 60%),
        #020617;
      color: var(--text-main);
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(15,23,42,0.55) 1px, transparent 1px),
        linear-gradient(90deg, rgba(15,23,42,0.55) 1px, transparent 1px);
      background-size: 56px 56px;
      opacity: 0.18;
      pointer-events: none;
      z-index: -2;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 32px;
    }

    .card {
      background:
        radial-gradient(circle at top left, rgba(15,23,42,0.95), rgba(15,23,42,0.98)),
        radial-gradient(circle at bottom right, rgba(15,23,42,0.95), #020617);
      border-radius: 24px;
      padding: 22px 22px 20px;
      box-shadow:
        0 35px 120px rgba(15,23,42,0.9),
        0 0 0 1px rgba(148,163,184,0.35);
      border: 1px solid rgba(31,41,55,0.95);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0% 0%, rgba(59,130,246,0.32), transparent 60%),
        radial-gradient(circle at 100% 100%, rgba(34,197,94,0.24), transparent 65%);
      opacity: 0.6;
      pointer-events: none;
      z-index: -1;
    }

    /* ===== Header ===== */
    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .title-block {
      display: flex;
      align-items: center;
      gap: 14px;
      flex-wrap: wrap;
    }

    .brand-logo {
      height: 34px;
      width: auto;
      display: block;
      filter: drop-shadow(0 0 12px rgba(15,23,42,0.9));
    }

    .brand-divider {
      width: 1px;
      height: 32px;
      background: rgba(55,65,81,0.95);
    }

    h1 {
      font-size: 1.9rem;
      margin: 0;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-top: 4px;
      margin-bottom: 0;
      max-width: 640px;
    }

    .badge-pill {
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.9);
      padding: 4px 11px;
      font-size: 0.72rem;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15,23,42,0.95);
      white-space: nowrap;
      box-shadow: 0 12px 40px rgba(15,23,42,0.9);
      backdrop-filter: blur(10px);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 0 0 rgba(34,197,94,0.65);
      animation: ping 1.6s cubic-bezier(0, 0, 0.2, 1) infinite;
    }

    @keyframes ping {
      0% {
        transform: scale(1);
        opacity: 0.9;
      }
      70% {
        transform: scale(1.9);
        opacity: 0;
      }
      100% {
        transform: scale(1.9);
        opacity: 0;
      }
    }

    /* Animated hero title */
    .hero-title {
      font-size: 1.9rem;
      margin: 0;
      letter-spacing: 0.02em;
      font-weight: 700;
      background:
        linear-gradient(120deg, #e5e7eb, #93c5fd, #a7f3d0, #facc15, #e5e7eb);
      background-size: 260% 260%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: gradientFlow 4s ease-in-out infinite;
    }

    @keyframes gradientFlow {
      0% {
        background-position: 0% 0%;
      }
      50% {
        background-position: 100% 100%;
      }
      100% {
        background-position: 0% 0%;
      }
    }

    /* ===== Layout ===== */
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.55fr) minmax(260px, 1fr);
      gap: 18px;
      margin-top: 10px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background:
        radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
      border-radius: 18px;
      padding: 14px 14px 14px;
      border: 1px solid rgba(55,65,81,0.9);
      box-shadow: 0 20px 55px rgba(15,23,42,0.8);
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(148,163,184,0.22), transparent 65%);
      opacity: 0.4;
      pointer-events: none;
    }

    .panel-inner {
      position: relative;
      z-index: 1;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .panel-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .panel-title-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(37,99,235,0.9);
    }

    .panel-subtitle {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    /* ===== Chat Area ===== */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 480px;
      max-height: 520px;
    }

    @media (max-height: 760px) {
      .chat-container {
        height: 420px;
      }
    }

    .chat-window {
      flex: 1;
      overflow-y: auto;
      padding: 8px 4px 10px;
      margin-bottom: 8px;
    }

    .chat-window::-webkit-scrollbar {
      width: 6px;
    }
    .chat-window::-webkit-scrollbar-track {
      background: rgba(15,23,42,0.9);
    }
    .chat-window::-webkit-scrollbar-thumb {
      background: rgba(55,65,81,0.95);
      border-radius: 999px;
    }

    .chat-message {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }

    .chat-message--assistant {
      justify-content: flex-start;
    }

    .chat-message--user {
      justify-content: flex-end;
    }

    .chat-avatar {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .chat-avatar-assistant {
      background: radial-gradient(circle at 30% 20%, #eff6ff 0, #60a5fa 40%, #1d4ed8 100%);
      box-shadow: 0 8px 22px rgba(37,99,235,0.6);
      border: 1px solid rgba(239,246,255,0.9);
      color: #020617;
      font-weight: 700;
    }

    .chat-avatar-user {
      background: radial-gradient(circle at 30% 20%, #f97316 0, #eab308 40%, #facc15 100%);
      box-shadow: 0 8px 22px rgba(248,250,252,0.3);
      border: 1px solid rgba(254,249,195,0.9);
      color: #111827;
      font-weight: 700;
    }

    .chat-bubble {
      max-width: 82%;
      border-radius: 18px;
      padding: 9px 11px;
      font-size: 0.88rem;
      line-height: 1.4;
      box-shadow: 0 14px 35px rgba(15,23,42,0.85);
      position: relative;
    }

    .chat-message--assistant .chat-bubble {
      background: radial-gradient(circle at top left, #0b1120, #020617);
      border: 1px solid rgba(55,65,81,0.9);
      color: #e5e7eb;
    }

    .chat-message--user .chat-bubble {
      background: linear-gradient(135deg, #1d4ed8, #22c55e);
      border: 1px solid rgba(191,219,254,0.9);
      color: #f9fafb;
    }

    .chat-bubble h1,
    .chat-bubble h2,
    .chat-bubble h3 {
      margin: 0.35rem 0 0.2rem;
      font-size: 0.95rem;
    }

    .chat-bubble p {
      margin: 0.15rem 0;
    }

    .chat-bubble ul,
    .chat-bubble ol {
      margin: 0.2rem 0 0.35rem 1.1rem;
      padding-left: 1rem;
    }

    .chat-bubble code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      background: rgba(31,41,55,0.9);
      padding: 1px 4px;
      border-radius: 4px;
    }

    .chat-message--welcome .chat-bubble {
      border: 1px solid rgba(59,130,246,0.4);
      box-shadow: 0 18px 55px rgba(37,99,235,0.65);
    }

    /* Composer */
    .chat-composer {
      border-radius: 15px;
      border: 1px solid rgba(55,65,81,0.95);
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(15,23,42,0.98));
      box-shadow:
        0 18px 60px rgba(15,23,42,0.9),
        0 0 0 1px rgba(15,23,42,0.9);
      padding: 8px 10px 9px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .composer-row-main {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    .composer-input-wrap {
      flex: 1;
      position: relative;
    }

    .composer-input-wrap textarea {
      width: 100%;
      min-height: 40px;
      max-height: 96px;
      border-radius: 12px;
      padding: 8px 10px 8px 10px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      font-size: 0.9rem;
      resize: none;
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(15,23,42,1);
      transition: border-color 0.16s ease, box-shadow 0.16s ease, background 0.16s ease, transform 0.06s ease;
    }

    .composer-input-wrap textarea::placeholder {
      color: rgba(148,163,184,0.85);
    }

    .composer-input-wrap textarea:focus {
      border-color: rgba(96,165,250,0.9);
      box-shadow:
        0 0 0 1px rgba(37,99,235,0.7),
        0 0 25px rgba(37,99,235,0.55);
      transform: translateY(-0.5px);
    }

    .composer-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      font-size: 0.72rem;
      color: var(--text-soft);
      flex-wrap: wrap;
    }

    .composer-left {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill-muted {
      border-radius: 999px;
      border: 1px dashed rgba(55,65,81,0.95);
      padding: 3px 9px;
      font-size: 0.72rem;
      color: var(--text-soft);
      background: rgba(17,24,39,0.9);
    }

    /* File upload */
    .file-input-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .file-button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.95);
      font-size: 0.78rem;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      transition: background 0.15s ease, transform 0.06s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .file-button-icon {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #020617;
      box-shadow: 0 10px 25px rgba(34,197,94,0.5);
    }

    .file-button:hover {
      background: rgba(15,23,42,1);
      transform: translateY(-0.5px);
      border-color: rgba(96,165,250,0.9);
      box-shadow: 0 12px 32px rgba(15,23,42,0.9);
    }

    /* Button */
    button {
      background: linear-gradient(135deg, #1d4ed8, #22c55e);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 8px 17px;
      font-size: 0.86rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      box-shadow:
        0 18px 40px rgba(37,99,235,0.7),
        0 0 0 1px rgba(59,130,246,0.8);
      transition: transform 0.07s ease, box-shadow 0.15s ease, filter 0.05s ease;
      white-space: nowrap;
    }

    button span#btnLabel {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-icon {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(248,250,252,0.95);
      border-top-color: rgba(15,23,42,0.7);
      animation: spin 0.9s linear infinite;
      display: none;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      filter: brightness(1.03);
      box-shadow:
        0 22px 50px rgba(37,99,235,0.9),
        0 0 0 1px rgba(59,130,246,1);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
      box-shadow:
        0 12px 30px rgba(15,23,42,0.9),
        0 0 0 1px rgba(37,99,235,0.9);
    }

    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      box-shadow: 0 0 0 1px rgba(55,65,81,0.95);
      filter: grayscale(0.2);
    }

    /* Right panel progress / summary */
    .progress-wrapper {
      margin-bottom: 10px;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      position: relative;
      padding: 6px 4px 4px;
    }

    .progress-steps::before {
      content: "";
      position: absolute;
      top: 14px;
      left: 8%;
      right: 8%;
      height: 2px;
      background: rgba(31,41,55,0.95);
      z-index: 0;
    }

    .progress-step {
      flex: 1;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .progress-dot {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      margin: 0 auto 4px;
      border: 2px solid rgba(55,65,81,0.95);
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .progress-label {
      font-size: 0.72rem;
      color: var(--text-soft);
      white-space: nowrap;
    }

    .progress-step.is-active .progress-dot {
      border-color: var(--accent);
      background: #0b1120;
      color: #bfdbfe;
      box-shadow: 0 0 0 3px rgba(29,78,216,0.55);
    }

    .progress-step.is-active .progress-label {
      color: #e5e7eb;
      font-weight: 600;
    }

    .progress-step.is-done .progress-dot {
      border-color: var(--success);
      background: #022c22;
      color: #bbf7d0;
    }

    .progress-step.is-done .progress-label {
      color: #bbf7d0;
    }

    .right-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }

    .status-pill {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      margin-left: 6px;
      border: 1px solid transparent;
      background: rgba(37,99,235,0.18);
      color: #bfdbfe;
      backdrop-filter: blur(8px);
    }

    .status-failed {
      background: rgba(248,113,113,0.16);
      color: #fecaca;
      border-color: rgba(248,113,113,0.7);
    }

    .status-success {
      background: rgba(34,197,94,0.16);
      color: #bbf7d0;
      border-color: rgba(74,222,128,0.8);
    }

    .status-progress {
      background: rgba(37,99,235,0.16);
      color: #bfdbfe;
      border-color: rgba(59,130,246,0.9);
    }

    h2 {
      font-size: 0.95rem;
      margin: 4px 0 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #e5e7eb;
    }

    .result-box {
      margin-top: 4px;
      max-height: 320px;
      overflow: auto;
      background: radial-gradient(circle at top, #020617, #020617);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(31,41,55,0.95);
      font-size: 0.86rem;
      box-shadow: inset 0 0 0 1px rgba(15,23,42,1);
    }

    .result-box::-webkit-scrollbar {
      width: 7px;
    }

    .result-box::-webkit-scrollbar-track {
      background: #020617;
    }

    .result-box::-webkit-scrollbar-thumb {
      background: rgba(55,65,81,0.95);
      border-radius: 999px;
    }

    .summary-markup {
      font-size: 0.86rem;
      line-height: 1.5;
      color: #e5e7eb;
    }

    .summary-markup h1,
    .summary-markup h2,
    .summary-markup h3 {
      margin: 0.4rem 0 0.3rem;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .summary-markup ul,
    .summary-markup ol {
      margin: 0.2rem 0 0.4rem 1.2rem;
      padding-left: 1.1rem;
    }

    .summary-markup li {
      margin-bottom: 0.15rem;
    }

    .summary-markup p {
      margin: 0.25rem 0;
    }

    .summary-markup code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(31,41,55,0.95);
      padding: 1px 4px;
      border-radius: 4px;
      font-size: 0.8rem;
    }

    .summary-loading {
      position: relative;
      overflow: hidden;
    }

    .summary-loading::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(
        110deg,
        transparent 0%,
        rgba(148,163,184,0.26) 40%,
        transparent 80%
      );
      animation: shimmer 0.7s infinite;
      pointer-events: none;
    }

    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(100%);
      }
    }

    .row-hint {
      font-size: 0.78rem;
      color: var(--text-soft);
      max-width: 260px;
    }

    /* Hide old clarification block (we‚Äôll drive clarifications via chat) */
    .clarification-section {
      display: none !important;
    }

  </style>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="page">
    <div class="card">
      <div class="header-row">
        <div class="title-block">
          <img
            src="{{ url_for('static', filename='icertis-logo.svg') }}"
            alt="Icertis Logo"
            class="brand-logo"
          />
          <div class="brand-divider"></div>
          <div>
            <h1 class="hero-title">
              AI-Powered Risk Orchestrator
              <span id="statusPill" class="status-pill status-progress" style="display:none;"></span>
            </h1>
            <p class="subtitle">
              Chat with an AI risk orchestrator. Paste a contract or upload a document ‚Äì the agents will classify
              risks, surface gaps, and ask for clarifications before producing a concise risk brief.
            </p>
          </div>
        </div>
        <div class="badge-pill">
          <span class="badge-dot"></span>
          Multi-agent ¬∑ Human-in-loop
        </div>
      </div>

      <div class="layout">
        <!-- LEFT: CHAT PANEL -->
        <div class="panel">
          <div class="panel-inner">
            <div class="panel-header">
              <div>
                <div class="panel-title">
                  <span class="panel-title-dot"></span>
                  Risk Orchestrator Chat
                </div>
                <div class="panel-subtitle">
                  Ask questions, describe your project, or respond to agent clarifications.
                </div>
              </div>
            </div>

            <div class="chat-container">
              <div id="chatWindow" class="chat-window">
                <!-- Initial assistant message -->
                <div class="chat-message chat-message--assistant chat-message--welcome">
                  <div class="chat-avatar chat-avatar-assistant">AI</div>
                  <div class="chat-bubble">
                    <p><strong>Hi, I‚Äôm your AI Risk Orchestrator.</strong></p>
                    <p>
                      Paste a contract or project description, or upload a <code>.docx</code>, <code>.pdf</code>, or
                      <code>.txt</code> file. I‚Äôll analyze risks, highlight gaps, and ask for clarifications where needed.
                    </p>
                    <p style="font-size:0.8rem; opacity:0.85;">
                      Example: ‚ÄúOur go-live depends on a new vendor API which has been unstable in testing. If it fails in
                      production, we have no rollback plan and tight customer SLAs.‚Äù
                    </p>
                  </div>
                </div>
              </div>

              <!-- Chat composer -->
              <form id="riskForm" enctype="multipart/form-data" onsubmit="return false;" class="chat-composer">
                <div class="composer-row-main">
                  <div class="composer-input-wrap">
                    <textarea
                      id="projectDescription"
                      name="project_description"
                      placeholder="Type your contract / project description or answer the agent‚Äôs questions‚Ä¶"></textarea>
                  </div>

                  <button id="analyzeBtn" type="button">
                    <div class="btn-icon" id="btnSpinner"></div>
                    <span id="btnLabel">Send & Analyze</span>
                  </button>
                </div>

                <div class="composer-actions">
                  <div class="composer-left">
                    <div class="file-input-wrapper">
                      <div class="file-button">
                        <span class="file-button-icon">üìÑ</span>
                        <span>Upload contract</span>
                      </div>
                      <input
                        type="file"
                        id="descriptionFile"
                        name="description_file"
                        accept=".txt,.pdf,.doc,.docx" />
                    </div>
                    <span class="pill-muted">.docx, .pdf, .txt supported</span>
                  </div>
                  <div class="row-hint">
                    Your latest message is treated as either
                    <strong>initial description</strong> or <strong>clarification</strong> depending on the workflow stage.
                  </div>
                </div>

                <!-- Old clarification section kept for compatibility but visually hidden -->
                <div id="clarificationSection" class="clarification-section">
                  <div class="clarification-title">Agent needs more information</div>
                  <ul id="clarificationList" class="clarification-list"></ul>
                  <textarea id="feedbackInput" name="feedback"></textarea>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- RIGHT: ORCHESTRATION OVERVIEW -->
        <div class="panel">
          <div class="panel-inner">
            <div class="panel-header">
              <div>
                <div class="panel-title">
                  <span class="panel-title-dot"></span>
                  Orchestration Overview
                </div>
                <div class="panel-subtitle">
                  Track workflow progress and see the latest assistant summary.
                </div>
              </div>
            </div>

            <div class="progress-wrapper">
              <div class="progress-steps">
                <div class="progress-step" data-step="1">
                  <div class="progress-dot">1</div>
                  <div class="progress-label">Input & Validation</div>
                </div>
                <div class="progress-step" data-step="2">
                  <div class="progress-dot">2</div>
                  <div class="progress-label">Risk Analysis</div>
                </div>
                <div class="progress-step" data-step="3">
                  <div class="progress-dot">3</div>
                  <div class="progress-label">Final Summary</div>
                </div>
              </div>
            </div>

            <div class="right-header-row">
              <h2>Latest Assistant Summary</h2>
            </div>

            <div id="summaryBox" class="result-box">
              <div id="summaryText" class="summary-markup">Waiting for your first message‚Ä¶</div>
            </div>
          </div>
        </div>
      </div> <!-- /layout -->
    </div>
  </div>

  <script>
    const btn = document.getElementById("analyzeBtn");
    const btnLabel = document.getElementById("btnLabel");
    const btnSpinner = document.getElementById("btnSpinner");
    const projectDescriptionEl = document.getElementById("projectDescription");
    const feedbackInputEl = document.getElementById("feedbackInput"); // hidden helper
    const clarificationSection = document.getElementById("clarificationSection");
    const clarificationList = document.getElementById("clarificationList");
    const summaryText = document.getElementById("summaryText");
    const statusPill = document.getElementById("statusPill");
    const fileInputEl = document.getElementById("descriptionFile");
    const progressSteps = document.querySelectorAll(".progress-step");
    const chatWindow = document.getElementById("chatWindow");

    // State: keep track if we‚Äôre answering clarifications
    let awaitingClarification = false;
    let lastProjectDescription = "";

    function updateProgress(step) {
      progressSteps.forEach(s => {
        const num = Number(s.dataset.step);
        s.classList.remove("is-active", "is-done");
        if (num < step) {
          s.classList.add("is-done");
        } else if (num === step) {
          s.classList.add("is-active");
        }
      });
    }
    updateProgress(1);

    function scrollChatToBottom() {
      if (!chatWindow) return;
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function appendMessage(role, markdown) {
      if (!chatWindow) return;
      const wrapper = document.createElement("div");
      wrapper.className = `chat-message chat-message--${role}`;

      const avatar = document.createElement("div");
      avatar.classList.add("chat-avatar");
      if (role === "assistant") {
        avatar.classList.add("chat-avatar-assistant");
        avatar.textContent = "AI";
      } else {
        avatar.classList.add("chat-avatar-user");
        avatar.textContent = "You";
      }

      const bubble = document.createElement("div");
      bubble.classList.add("chat-bubble");

      if (window.marked && typeof marked.parse === "function") {
        bubble.innerHTML = marked.parse(markdown);
      } else {
        bubble.textContent = markdown;
      }

      if (role === "assistant") {
        wrapper.appendChild(avatar);
        wrapper.appendChild(bubble);
      } else {
        wrapper.appendChild(bubble);
        wrapper.appendChild(avatar);
      }

      chatWindow.appendChild(wrapper);
      scrollChatToBottom();
    }

    function renderMarkdown(targetEl, markdown) {
      if (!targetEl) return;
      if (window.marked && typeof marked.parse === "function") {
        targetEl.innerHTML = marked.parse(markdown);
      } else {
        targetEl.textContent = markdown;
      }
    }

    function setStatusPill(status) {
      statusPill.style.display = status ? "inline-block" : "none";
      statusPill.className = "status-pill";

      if (!status) return;

      if (status === "failed") {
        statusPill.textContent = "Failed";
        statusPill.classList.add("status-failed");
      } else if (status === "success") {
        statusPill.textContent = "Ready";
        statusPill.classList.add("status-success");
      } else {
        statusPill.textContent = "In Progress";
        statusPill.classList.add("status-progress");
      }
    }

    function showClarification(clarifications) {
      // Old UI (kept hidden) ‚Äì keep it in sync just in case
      if (!clarifications || !clarifications.length) {
        if (clarificationSection) {
          clarificationSection.style.display = "none";
        }
        if (clarificationList) clarificationList.innerHTML = "";
        if (feedbackInputEl) feedbackInputEl.value = "";
        awaitingClarification = false;
        return;
      }

      awaitingClarification = true;

      // Populate hidden list
      if (clarificationList) {
        clarificationList.innerHTML = "";
        clarifications.forEach(q => {
          const li = document.createElement("li");
          li.textContent = q;
          clarificationList.appendChild(li);
        });
      }

      // Chat-style message
      const md =
        "### Clarification required\n\n" +
        (clarifications.length
          ? "The risk analysis agent needs more information:\n\n" +
            clarifications.map((c, i) => `${i + 1}. ${c}`).join("\n") +
            "\n\nReply in the chat box with your answers, then press **Send & Analyze** again."
          : "Please provide additional details in your next message and press **Send & Analyze** again.");

      appendMessage("assistant", md);
    }

    function setLoading(isLoading) {
      if (isLoading) {
        btn.disabled = true;
        btnSpinner.style.display = "inline-block";
        summaryText.classList.add("summary-loading");
      } else {
        btn.disabled = false;
        btnSpinner.style.display = "none";
        summaryText.classList.remove("summary-loading");
      }
    }

    // File upload ‚Üí also append a small chat note when the file is processed
    fileInputEl.addEventListener("change", async () => {
      const file = fileInputEl.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("description_file", file);

      try {
        setLoading(true);
        const res = await fetch("/upload_contract", {
          method: "POST",
          body: formData,
        });

        const data = await res.json();

        if (!res.ok || data.status !== "success") {
          alert("File upload failed: " + (data.message || "Unknown error"));
          return;
        }

        const text = data.project_description || "";
        if (text) {
          projectDescriptionEl.value = text;
          appendMessage(
            "assistant",
            `I‚Äôve extracted text from your uploaded file **${file.name}**.\n\nYou can review or edit it in the input box, then press **Send & Analyze** to start the risk review.`
          );
        }
      } catch (e) {
        alert("Upload error: " + e.message);
      } finally {
        setLoading(false);
      }
    });

    btn.addEventListener("click", async () => {
      const rawText = projectDescriptionEl.value.trim();

      if (!rawText) {
        alert("Please type a description or clarification before sending.");
        return;
      }

      // Decide whether this message is a new project description or a clarification
      let projectTextToSend = "";
      let feedbackTextToSend = "";

      if (!awaitingClarification || !lastProjectDescription) {
        // Treat as fresh project description
        lastProjectDescription = rawText;
        projectTextToSend = rawText;
        feedbackTextToSend = "";
      } else {
        // We are answering clarifications; keep original project description
        projectTextToSend = lastProjectDescription;
        feedbackTextToSend = rawText;
      }

      // Add user message to chat
      appendMessage("user", rawText);

      // Clear composer for next message
      projectDescriptionEl.value = "";

      setLoading(true);
      setStatusPill("in_progress");
      updateProgress(1);
      renderMarkdown(summaryText, "_Analyzing with orchestrator agents‚Ä¶_");
      btnLabel.textContent = "Running risk orchestration‚Ä¶";

      const payload = {
        project_description: projectTextToSend,
        feedback: feedbackTextToSend || ""
      };

      try {
        const res = await fetch("/analyze_contract_risk", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        // Handle validation / failure
        if (!res.ok || data.status === "failed") {
          setStatusPill("failed");
          updateProgress(1);
          awaitingClarification = false;

          const errorMarkdown =
            "**Validation failed.**\n\n" +
            (data.message || "") +
            (data.errors && data.errors.length
              ? "\n\n**Details:**\n" + data.errors.map(e => `- ${e}`).join("\n")
              : "");

          renderMarkdown(summaryText, errorMarkdown);
          appendMessage("assistant", errorMarkdown);
          btnLabel.textContent = "Send & Analyze";
          return;
        }

        // Human-in-the-loop clarification
        if (
          data.status === "in_progress" &&
          data.risk_analysis_report &&
          data.risk_analysis_report.human_input === true
        ) {
          const clarifications = Array.isArray(data.risk_analysis_report.clarification)
            ? data.risk_analysis_report.clarification
            : [];

          showClarification(clarifications);
          renderMarkdown(
            summaryText,
            "### Clarification required\n\n" +
              (clarifications.length
                ? "The risk analysis agent needs more information:\n\n" +
                  clarifications.map((c, i) => `${i + 1}. ${c}`).join("\n")
                : "Please provide additional details in your next message.")
          );
          updateProgress(2);
          setStatusPill("in_progress");
          btnLabel.textContent = "Send & Analyze";
          return;
        }

        // Success path
        const finalSummary = data.summary || "No summary available.";
        renderMarkdown(summaryText, finalSummary);
        appendMessage("assistant", finalSummary);

        setStatusPill("success");
        updateProgress(3);
        btnLabel.textContent = "Send & Analyze";
        awaitingClarification = false;
        if (feedbackInputEl) feedbackInputEl.value = "";
        showClarification(null);

      } catch (e) {
        setStatusPill("failed");
        updateProgress(1);
        const errText = "Request failed: " + e.message;
        renderMarkdown(summaryText, errText);
        appendMessage("assistant", errText);
        btnLabel.textContent = "Send & Analyze";
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
